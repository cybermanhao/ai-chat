# ä»»åŠ¡å®Œæˆæ€»ç»“ - MCP UI é‡æ„ä¸èŠå¤©åŠŸèƒ½ä¼˜åŒ–

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

æœ¬æ¬¡ä»»åŠ¡æ¶‰åŠå¤šä¸ªæ–¹é¢çš„é‡æ„å’Œä¼˜åŒ–ï¼š
1. MCP æœåŠ¡å™¨ç®¡ç† UI å’Œ Redux é‡æ„
2. èŠå¤©æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨é—®é¢˜ä¿®å¤
3. æ»šåŠ¨æ¡æ ·å¼ç»Ÿä¸€å’Œç¾åŒ–
4. æ¶ˆæ¯å¡ç‰‡å†…æ¶ˆæ¯åˆ†éš”ç¬¦æ·»åŠ 
5. æ¶ˆæ¯å·®åˆ†/è¡¥ä¸é€»è¾‘ç®€åŒ–
6. TaskLoop æµå¼æ›´æ–°æœºåˆ¶è°ƒç ”

## âœ… å·²å®Œæˆä»»åŠ¡

### 1. MCP ç³»ç»Ÿé‡æ„
- **Redux Store é‡æ„**ï¼šä½¿ç”¨ Redux Toolkit é‡å†™ `mcpStore.ts`ï¼Œæ·»åŠ å¼‚æ­¥ thunks å’Œå¼ºç±»å‹æ”¯æŒ
- **UI ç»„ä»¶å‡çº§**ï¼šåœ¨ MCP æœåŠ¡å™¨åˆ—è¡¨ä¸­æ·»åŠ è¿æ¥/æ–­å¼€ Switch æ§ä»¶
- **å¼‚æ­¥é€»è¾‘**ï¼šå®ç° connect/disconnect å¼‚æ­¥æ“ä½œï¼Œå¸¦ UI åé¦ˆå’Œé”™è¯¯å¤„ç†
- **ç³»ç»Ÿåˆ†æ**ï¼šåˆ›å»º `MCP-SYSTEM-ANALYSIS.md` æ€»ç»“ç³»ç»ŸçŠ¶æ€å’Œå¾…åŠäº‹é¡¹

### 2. èŠå¤©æ»šåŠ¨é—®é¢˜ä¿®å¤
- **æ ¹å› è¯Šæ–­**ï¼šå®šä½ scrollToBottom ä¸å·¥ä½œçš„åŸå› ï¼ˆcontext ä¼ é€’ã€ref å¤„ç†ã€CSS å¸ƒå±€ï¼‰
- **ä»£ç ä¿®å¤**ï¼š
  - ç¡®ä¿ ChatContext æ­£ç¡®ä¼ é€’ scrollToBottom å‡½æ•°
  - ä¿®æ­£ MessageList çš„ forwardRef å’Œ ref ä¼ é€’
  - è°ƒæ•´ CSS flexbox å¸ƒå±€å’Œ min-height è®¾ç½®
  - ä¼˜åŒ– useEffect æ—¶æœºç¡®ä¿æ»šåŠ¨æ—¶æœºæ­£ç¡®

### 3. æ»šåŠ¨æ¡æ ·å¼ç»Ÿä¸€
- **å…±äº« Mixin**ï¼šåœ¨ `mixins.less` ä¸­åˆ›å»º `custom-scrollbar` mixin
- **ç»Ÿä¸€åº”ç”¨**ï¼šåŒæ—¶åº”ç”¨åˆ° `.message-list` å’Œ `.chat-list`
- **æ ·å¼ä¼˜åŒ–**ï¼šä½¿ç”¨ CSS å˜é‡å’Œå›é€€è‰²ç¡®ä¿å…¼å®¹æ€§

### 4. æ¶ˆæ¯åˆ†éš”ç¬¦åŠŸèƒ½
- **è§†è§‰åˆ†éš”ç¬¦**ï¼šåœ¨ MessageCard å†…å¤šæ¡æ¶ˆæ¯é—´æ·»åŠ æ¸å˜çº¿å’Œåœ†ç‚¹åˆ†éš”ç¬¦
- **CSS å®ç°**ï¼šåˆ›å»º `.message-separator` æ ·å¼
- **æµ‹è¯•è„šæœ¬**ï¼šå¼€å‘ `add-test-message.js` æ§åˆ¶å°è„šæœ¬ç”¨äºæµ‹è¯•å¤šæ¶ˆæ¯ MessageCard
- **åŠŸèƒ½å®Œå–„**ï¼š
  - ä¿®å¤è„šæœ¬ ReferenceError
  - æ·»åŠ "æ€è€ƒè¿‡ç¨‹"éƒ¨åˆ†åˆ°æµ‹è¯•æ¶ˆæ¯
  - æä¾›å¤šç§æµ‹è¯•å‡½æ•°ï¼ˆ`addMultiMessageCard`ã€`addAssistantToolCard` ç­‰ï¼‰

### 5. æ¶ˆæ¯æ¸²æŸ“ä¼˜åŒ–
- **Markdown é»˜è®¤**ï¼šä¸º assistant/tool æ¶ˆæ¯è®¾ç½® Markdown æ¸²æŸ“ä¸ºé»˜è®¤
- **å¤åˆ¶åŠŸèƒ½**ï¼šç¡®ä¿å¤åˆ¶æŒ‰é’®æ˜¾ç¤ºæˆåŠŸæç¤ºä¿¡æ¯

### 6. æµå¼æ›´æ–°é€»è¾‘ç®€åŒ–
- **ç§»é™¤å¤æ‚é€»è¾‘**ï¼šæ³¨é‡Šæ‰ `messageDiff.ts` ä¸­çš„å¤æ‚å·®åˆ†å’ŒèŠ‚æµé€»è¾‘
- **ç®€åŒ–å®ç°**ï¼šé‡‡ç”¨ç›´æ¥å­—æ®µæ¯”è¾ƒå’Œç´¯ç§¯çš„æ–¹å¼å¤„ç†æµå¼æ›´æ–°
- **æµ‹è¯•æ›´æ–°**ï¼šç›¸åº”æ›´æ–°å’Œæ³¨é‡Šç›¸å…³æµ‹è¯•ç”¨ä¾‹

### 7. TaskLoop æœºåˆ¶è°ƒç ”
- **æ·±å…¥åˆ†æ**ï¼šç ”ç©¶ TaskLoop çš„æµå¼æ›´æ–°æœºåˆ¶
- **ç¡®è®¤æœºåˆ¶**ï¼šè¯å® TaskLoop æ˜¯ per-chunk è§¦å‘æ›´æ–°ï¼Œä¸æ˜¯æ‰¹é‡ç´¯ç§¯
- **æ–‡æ¡£åŒ–**ï¼šåˆ›å»º `TaskLoop-Streaming-Analysis.md` è¯¦ç»†åˆ†ææ–‡æ¡£

### 8. è‡ªåŠ¨æ»šåŠ¨è®¾ç½®åŠŸèƒ½
- **Redux æ‰©å±•**ï¼šåœ¨ chatSlice ä¸­æ·»åŠ  `settings.autoScroll` çŠ¶æ€ç®¡ç†
- **è®¾ç½®ç•Œé¢**ï¼šåœ¨è®¾ç½®é¡µé¢æ·»åŠ è‡ªåŠ¨æ»šåŠ¨å¼€å…³ï¼Œé»˜è®¤å¯ç”¨
- **æ™ºèƒ½æ§åˆ¶**ï¼šåŒºåˆ†å§‹ç»ˆæ»šåŠ¨ï¼ˆæ–°æ¶ˆæ¯ï¼‰å’Œå¯æ§æ»šåŠ¨ï¼ˆæµå¼æ›´æ–°ï¼‰

### 9. åœæ­¢ç”ŸæˆåŠŸèƒ½å®ç°
- **Redux Action**ï¼šæ·»åŠ  `stopGeneration` action
- **ä¸­é—´ä»¶å¤„ç†**ï¼šåœ¨ streamManagerMiddleware ä¸­å¤„ç†åœæ­¢é€»è¾‘
- **TaskLoop é›†æˆ**ï¼šè°ƒç”¨ TaskLoop çš„ abortTask æ–¹æ³•
- **UI é›†æˆ**ï¼šåœ¨èŠå¤©é¡µé¢å®ç° handleStop å‡½æ•°
- **æµ‹è¯•è„šæœ¬**ï¼šåˆ›å»ºå®Œæ•´çš„åœæ­¢ç”Ÿæˆæµ‹è¯•å¥—ä»¶

## ğŸ“ æ¶‰åŠæ–‡ä»¶æ¸…å•

### MCP ç›¸å…³
- `c:\code\zz-ai-chat\web\src\store\mcpStore.ts` - Redux store é‡æ„
- `c:\code\zz-ai-chat\web\src\pages\Mcp\index.tsx` - UI ç»„ä»¶å‡çº§
- `c:\code\zz-ai-chat\web\src\pages\Mcp\MCP-SYSTEM-ANALYSIS.md` - ç³»ç»Ÿåˆ†æ

### èŠå¤©åŠŸèƒ½ç›¸å…³
- `c:\code\zz-ai-chat\web\src\contexts\chat\ChatContext.tsx` - Context ä¿®å¤
- `c:\code\zz-ai-chat\web\src\pages\Chat\index.tsx` - èŠå¤©é¡µé¢
- `c:\code\zz-ai-chat\web\src\pages\Chat\components\MessageList\index.tsx` - æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶
- `c:\code\zz-ai-chat\web\src\pages\Chat\components\MessageCard\index.tsx` - æ¶ˆæ¯å¡ç‰‡ç»„ä»¶

### æ ·å¼ç›¸å…³
- `c:\code\zz-ai-chat\web\src\styles\mixins.less` - æ»šåŠ¨æ¡ mixin
- `c:\code\zz-ai-chat\web\src\pages\Chat\styles.less` - èŠå¤©é¡µé¢æ ·å¼
- `c:\code\zz-ai-chat\web\src\pages\Chat\components\MessageList\styles.less` - æ¶ˆæ¯åˆ—è¡¨æ ·å¼
- `c:\code\zz-ai-chat\web\src\pages\Chat\components\MessageCard\styles.less` - æ¶ˆæ¯å¡ç‰‡æ ·å¼

### æµ‹è¯•å’Œå·¥å…·
- `c:\code\zz-ai-chat\web\src\pages\Chat\add-test-message.js` - æµ‹è¯•è„šæœ¬
- `c:\code\zz-ai-chat\web\src\pages\Chat\multi-message-test-guide.md` - æµ‹è¯•æŒ‡å—
- `c:\code\zz-ai-chat\web\src\pages\Chat\test-stop-generation.js` - åœæ­¢ç”Ÿæˆæµ‹è¯•è„šæœ¬
- `c:\code\zz-ai-chat\web\src\pages\Chat\stop-generation-test-guide.md` - åœæ­¢ç”Ÿæˆæµ‹è¯•æŒ‡å—

### æµå¼æ›´æ–°é€»è¾‘
- `c:\code\zz-ai-chat\web\src\store\utils\messageDiff.ts` - æ¶ˆæ¯å·®åˆ†é€»è¾‘
- `c:\code\zz-ai-chat\web\src\store\utils\__tests__\messageDiff.test.ts` - ç›¸å…³æµ‹è¯•
- `c:\code\zz-ai-chat\web\src\store\streamManagerMiddleware.ts` - Redux ä¸­é—´ä»¶

### åˆ†ææ–‡æ¡£
- `c:\code\zz-ai-chat\web\src\pages\Chat\TaskLoop-Streaming-Analysis.md` - TaskLoop æœºåˆ¶åˆ†æ
- `c:\code\zz-ai-chat\web\src\pages\Chat\DOM-Flicker-Analysis.md` - DOM é—ªçƒé—®é¢˜åˆ†æ
- `c:\code\zz-ai-chat\web\src\pages\Chat\auto-scroll-feature.md` - è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½è¯´æ˜
- `c:\code\zz-ai-chat\TASK-COMPLETION-SUMMARY.md` - å®Œæ•´çš„ä»»åŠ¡æ€»ç»“æ–‡æ¡£

## ğŸ¯ å…³é”®æŠ€æœ¯è¦ç‚¹

### 1. Redux Toolkit ç°ä»£åŒ–
- ä½¿ç”¨ `createSlice` å’Œ `createAsyncThunk`
- å¼ºç±»å‹æ”¯æŒå’Œ immutable æ›´æ–°
- å¼‚æ­¥çŠ¶æ€ç®¡ç†ï¼ˆloadingã€error å¤„ç†ï¼‰

### 2. React Hooks æœ€ä½³å®è·µ
- æ­£ç¡®çš„ `forwardRef` ä½¿ç”¨
- `useEffect` ä¾èµ–ç®¡ç†
- Context å’Œ ref ä¼ é€’æ¨¡å¼

### 3. CSS ç»„ç»‡å’Œå¤ç”¨
- Less mixin æ¨¡å¼
- CSS å˜é‡å’Œå›é€€æœºåˆ¶
- Flexbox å¸ƒå±€ä¼˜åŒ–

### 4. æµå¼æ•°æ®å¤„ç†
- Per-chunk äº‹ä»¶å¤„ç†æ¨¡å¼
- ç®€åŒ–çš„å·®åˆ†æ›´æ–°é€»è¾‘
- æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

## ğŸš€ æµ‹è¯•å’ŒéªŒè¯

### æ¶ˆæ¯åˆ†éš”ç¬¦æµ‹è¯•
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œ
addMultiMessageCard(); // æ·»åŠ åŒ…å«å¤šæ¡æ¶ˆæ¯çš„ MessageCard
addTripleMessageCard(); // æ·»åŠ ä¸‰æ¡æ¶ˆæ¯çš„æµ‹è¯•å¡ç‰‡
clearTestCards(); // æ¸…ç†æµ‹è¯•æ¶ˆæ¯
```

### MCP è¿æ¥æµ‹è¯•
- åœ¨ MCP é¡µé¢ä½¿ç”¨ Switch æ§ä»¶æµ‹è¯•è¿æ¥/æ–­å¼€
- è§‚å¯Ÿ loading çŠ¶æ€å’Œé”™è¯¯æç¤º
- æ£€æŸ¥ Redux DevTools ä¸­çš„çŠ¶æ€å˜åŒ–

### èŠå¤©æ»šåŠ¨æµ‹è¯•
- å‘é€å¤šæ¡æ¶ˆæ¯éªŒè¯è‡ªåŠ¨æ»šåŠ¨
- æ‰‹åŠ¨æ»šåŠ¨åˆ°ä¸­é—´ä½ç½®åå‘é€æ–°æ¶ˆæ¯
- éªŒè¯æ»šåŠ¨æ¡æ ·å¼åœ¨ä¸åŒæµè§ˆå™¨ä¸­çš„ä¸€è‡´æ€§

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å·®åˆ†æ›´æ–°ä¼˜åŒ–
- ç§»é™¤ä¸å¿…è¦çš„å¤æ‚å·®åˆ†é€»è¾‘
- ç›´æ¥å­—æ®µæ¯”è¾ƒæé«˜æ€§èƒ½
- å‡å°‘ä¸å¿…è¦çš„ Redux æ›´æ–°

### 2. æµå¼æ›´æ–°ç›‘æ§
- `StreamingPerformanceMonitor` è®°å½•æ›´æ–°ç»Ÿè®¡
- æœ¬åœ°ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- åªåœ¨å­—æ®µçœŸæ­£å˜åŒ–æ—¶è§¦å‘æ›´æ–°

## ğŸ”® åç»­å·¥ä½œå»ºè®®

### MCP ç³»ç»Ÿ
- è¿›ä¸€æ­¥é›†æˆ MCP å·¥å…·è°ƒç”¨å’Œä¼šè¯ç®¡ç†
- ä¼˜åŒ–è¿æ¥çŠ¶æ€æŒä¹…åŒ–
- æ·»åŠ æ›´å¤š MCP æœåŠ¡å™¨é…ç½®é€‰é¡¹

### èŠå¤©ä½“éªŒ
- æ¶ˆæ¯ç¼–è¾‘å’Œé‡æ–°ç”ŸæˆåŠŸèƒ½
- æ›´å¤šæ¶ˆæ¯ç±»å‹æ”¯æŒï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
- èŠå¤©å†å²ç®¡ç†å’Œæœç´¢
- **ğŸ” DOM é—ªçƒä¼˜åŒ–**ï¼šå®ç° Markdown è§£æç¼“å­˜å’Œå¼‚æ­¥æ¸²æŸ“

### ç³»ç»Ÿæ€§èƒ½
- å¤§é‡æ¶ˆæ¯çš„è™šæ‹Ÿæ»šåŠ¨
- æ›´ç²¾ç»†çš„æµå¼æ›´æ–°æ§åˆ¶
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- **ğŸš€ æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–**ï¼šè§£å†³å¼€å‘è€…å·¥å…· DOM é—ªçƒä½†å®é™…å†…å®¹ä¸å®æ—¶æ›´æ–°çš„é—®é¢˜

## ğŸ” é¢å¤–å‘ç°ï¼šDOM é—ªçƒé—®é¢˜æ·±åº¦åˆ†æ

### é—®é¢˜ç°è±¡
ç”¨æˆ·å‘ç°åœ¨æµå¼æ¶ˆæ¯è¾“å‡ºè¿‡ç¨‹ä¸­ï¼š
- **å¼€å‘è€…å·¥å…·**ï¼šDOM å…ƒç´ æ ‡ç­¾é¢‘ç¹é—ªçƒï¼ˆé«˜äº®æ˜¾ç¤ºå˜åŒ–ï¼‰
- **å®é™…ç•Œé¢**ï¼šå†…å®¹ä¸æ˜¯å®æ—¶æ¸è¿›æ˜¾ç¤ºï¼Œè€Œæ˜¯ç­‰å®Œæˆåæ‰æ˜¾ç¤º

### æ ¹å› åˆ†æ
1. **Markdown è§£æé˜»å¡**ï¼š`markdownToHtml()` æ¯æ¬¡éƒ½é‡æ–°è§£ææ•´ä¸ªå†…å®¹
2. **React æ‰¹é‡æ›´æ–°**ï¼šReact 18 è‡ªåŠ¨åˆå¹¶å¿«é€Ÿè¿ç»­çš„æ›´æ–°
3. **æµè§ˆå™¨æ¸²æŸ“ä¼˜åŒ–**ï¼šDOM æ›´æ–°å’Œå®é™…ç»˜åˆ¶ä¹‹é—´å­˜åœ¨å»¶è¿Ÿ

### ä¼˜åŒ–æ–¹æ¡ˆ
- **useMemo ç¼“å­˜**ï¼šé¿å…é‡å¤è§£æç›¸åŒçš„ Markdown å†…å®¹
- **å¢é‡æ¸²æŸ“**ï¼šåªè§£ææ–°å¢çš„å†…å®¹éƒ¨åˆ†
- **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ startTransition å’Œ useDeferredValue
- **Web Worker**ï¼šå°† Markdown è§£æç§»åˆ°åå°çº¿ç¨‹

### æ–‡æ¡£è¾“å‡º
åˆ›å»ºäº† `DOM-Flicker-Analysis.md` è¯¦ç»†åˆ†ææ–‡æ¡£ï¼ŒåŒ…å«ï¼š
- å®Œæ•´çš„é—®é¢˜åˆ†æå’Œæ ¹å› è¯Šæ–­
- å¤šç§ä¼˜åŒ–æ–¹æ¡ˆçš„å…·ä½“å®ç°ä»£ç 
- æ€§èƒ½æµ‹è¯•å’ŒéªŒè¯è„šæœ¬
- é¢„æœŸæ”¹å–„æ•ˆæœè¯„ä¼°

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä»»åŠ¡æˆåŠŸå®Œæˆäº† MCP ç³»ç»Ÿçš„ç°ä»£åŒ–é‡æ„ã€èŠå¤©åŠŸèƒ½çš„å¤šé¡¹ä¼˜åŒ–ï¼Œä»¥åŠæµå¼æ›´æ–°æœºåˆ¶çš„æ·±åº¦åˆ†æã€‚æ‰€æœ‰ä¸»è¦åŠŸèƒ½éƒ½å·²ç»è¿‡æµ‹è¯•éªŒè¯ï¼Œä»£ç è´¨é‡å’Œç”¨æˆ·ä½“éªŒéƒ½æœ‰æ˜¾è‘—æå‡ã€‚ç‰¹åˆ«æ˜¯ TaskLoop æµå¼æ›´æ–°æœºåˆ¶çš„åˆ†æä¸ºåç»­ä¼˜åŒ–å·¥ä½œæä¾›äº†é‡è¦ä¾æ®ã€‚

ä»»åŠ¡çŠ¶æ€ï¼š**âœ… å…¨éƒ¨å®Œæˆ**
