<!DOCTYPE html>
<html>
<head>
    <title>真实 LLM 测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .button { background: #1677ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0958d9; }
        .button.danger { background: #ff4d4f; }
        .button.success { background: #52c41a; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .status.error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
        .status.info { background: #e6f7ff; border: 1px solid #91d5ff; color: #1677ff; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group textarea { width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>🧪 真实 LLM 端到端测试</h1>
            <p>这个页面用于测试 TaskLoop → MessageBridge → LLMService 的完整流程</p>
            
            <div class="input-group">
                <label>API Key (可选，不填则使用应用配置):</label>
                <input type="password" id="apiKey" placeholder="留空使用默认配置">
            </div>
            
            <div class="input-group">
                <label>测试消息:</label>
                <textarea id="testMessage" rows="3">你好，这是一个端到端的架构测试。请简短回复确认你收到了这条消息。</textarea>
            </div>
            
            <div class="input-group">
                <button class="button" onclick="testRealLLM()">🚀 开始真实 LLM 测试</button>
                <button class="button danger" onclick="abortTest()">🛑 中断测试</button>
                <button class="button" onclick="clearLog()">🧹 清空日志</button>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
            
            <div class="card">
                <h3>📋 测试日志</h3>
                <div id="log" class="log">等待测试开始...</div>
            </div>
            
            <div class="card">
                <h3>💬 LLM 响应</h3>
                <div id="response" class="log">等待 LLM 响应...</div>
            </div>
        </div>
    </div>

    <script type="module">
        let currentTaskLoop = null;
        let currentUnsubscribe = null;
        
        window.testRealLLM = async function () {
            showStatus('开始真实 LLM 测试...', 'info');
            addLog('=== 真实 LLM 端到端测试开始 ===');
            
            try {
                // 获取测试参数
                const apiKeyInput = document.getElementById('apiKey').value.trim();
                const testMessage = document.getElementById('testMessage').value.trim();
                
                if (!testMessage) {
                    throw new Error('请输入测试消息');
                }
                
                // 动态导入模块
                addLog('📦 导入必要模块...');
                const { TaskLoop } = await import('./src/store/index.js').catch(() => 
                    import('/src/engine/stream/task-loop.js').catch(() => {
                        throw new Error('无法导入 TaskLoop 模块，请确保在正确的应用环境中运行');
                    })
                );
                
                const { llms } = await import('/src/engine/utils/llms.js').catch(() => {
                    throw new Error('无法导入 llms 配置');
                });
                
                addLog('✅ 模块导入成功');
                
                // 获取 LLM 配置
                let apiKey = apiKeyInput;
                let llmConfig = llms[0]; // 默认使用第一个 (deepseek)
                
                if (!apiKey) {
                    // 尝试从应用配置获取
                    const store = window.__REDUX_STORE__;
                    if (store) {
                        const state = store.getState();
                        apiKey = state.llmConfig?.apiKeys?.deepseek || '';
                        addLog(`✅ 从应用配置获取 API Key: ${apiKey ? '已配置' : '未配置'}`);
                    }
                }
                
                if (!apiKey) {
                    throw new Error('API Key 未配置，请在输入框中输入或在应用设置中配置');
                }
                
                addLog(`🔧 使用 LLM 配置: ${llmConfig.name} (${llmConfig.models[0]})`);
                
                // 创建 TaskLoop
                addLog('🚀 创建 TaskLoop 实例...');
                currentTaskLoop = new TaskLoop({
                    chatId: 'e2e-test-' + Date.now(),
                    history: [],
                    config: {
                        baseURL: llmConfig.baseUrl,
                        apiKey: apiKey,
                        model: llmConfig.models[0],
                        temperature: 0.7,
                        maxTokens: 200
                    },
                    mcpClient: null
                });
                
                addLog('✅ TaskLoop 实例创建成功');
                
                // 设置事件监听
                let eventCount = 0;
                let responseContent = '';
                let startTime = Date.now();
                
                currentUnsubscribe = currentTaskLoop.subscribe((event) => {
                    eventCount++;
                    const timestamp = Date.now() - startTime;
                    addLog(`[${timestamp}ms] 📦 事件 ${eventCount}: ${event.type}`);
                    
                    switch (event.type) {
                        case 'add':
                            if (event.message?.role === 'user') {
                                addLog(`  └─ 用户消息: ${event.message.content?.substring(0, 50)}...`);
                            }
                            if (event.message?.role === 'assistant') {
                                addLog(`  └─ 助手消息开始`);
                                responseContent = event.message.content || '';
                                updateResponse(responseContent);
                            }
                            break;
                            
                        case 'update':
                            if (event.message?.content) {
                                responseContent = event.message.content;
                                updateResponse(responseContent);
                                addLog(`  └─ 流式更新: 长度 ${responseContent.length}`);
                            }
                            break;
                            
                        case 'status':
                            addLog(`  └─ 状态: ${event.status || JSON.stringify(event)}`);
                            break;
                            
                        case 'done':
                            const duration = Date.now() - startTime;
                            addLog(`  └─ 完成！用时: ${duration}ms`);
                            showStatus(`✅ 测试成功完成！响应长度: ${responseContent.length} 字符，用时: ${duration}ms`, 'success');
                            cleanup();
                            break;
                            
                        case 'error':
                            addLog(`  └─ 错误: ${event.error || JSON.stringify(event)}`);
                            showStatus(`❌ 测试失败: ${event.error}`, 'error');
                            cleanup();
                            break;
                    }
                });
                
                // 开始测试
                addLog(`🚀 发送测试消息: "${testMessage}"`);
                showStatus('正在发送消息到 LLM...', 'info');
                
                await currentTaskLoop.start(testMessage);
                
            } catch (error) {
                addLog(`❌ 测试异常: ${error.message}`);
                showStatus(`❌ 测试失败: ${error.message}`, 'error');
                cleanup();
            }
        };
        
        window.abortTest = function () {
            if (currentTaskLoop) {
                addLog('🛑 中断测试...');
                currentTaskLoop.abortTask();
                showStatus('测试已中断', 'info');
                cleanup();
            }
        };
        
        window.clearLog = function () {
            document.getElementById('log').innerHTML = '';
            document.getElementById('response').innerHTML = '等待 LLM 响应...';
            hideStatus();
        };
        
        function cleanup() {
            if (currentUnsubscribe) {
                currentUnsubscribe();
                currentUnsubscribe = null;
            }
            currentTaskLoop = null;
        }
        
        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateResponse(content) {
            document.getElementById('response').innerHTML = content || '(空响应)';
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        // 页面加载时的初始化
        addLog('📄 测试页面已加载，准备就绪');
        addLog('💡 提示: 请确保在正确的应用环境中运行此测试');
    </script>
</body>
</html>