<!DOCTYPE html>
<html>
<head>
    <title>çœŸå® LLM æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .button { background: #1677ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0958d9; }
        .button.danger { background: #ff4d4f; }
        .button.success { background: #52c41a; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .status.error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
        .status.info { background: #e6f7ff; border: 1px solid #91d5ff; color: #1677ff; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group textarea { width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ§ª çœŸå® LLM ç«¯åˆ°ç«¯æµ‹è¯•</h1>
            <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯• TaskLoop â†’ MessageBridge â†’ LLMService çš„å®Œæ•´æµç¨‹</p>
            
            <div class="input-group">
                <label>API Key (å¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨åº”ç”¨é…ç½®):</label>
                <input type="password" id="apiKey" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®">
            </div>
            
            <div class="input-group">
                <label>æµ‹è¯•æ¶ˆæ¯:</label>
                <textarea id="testMessage" rows="3">ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ¶æ„æµ‹è¯•ã€‚è¯·ç®€çŸ­å›å¤ç¡®è®¤ä½ æ”¶åˆ°äº†è¿™æ¡æ¶ˆæ¯ã€‚</textarea>
            </div>
            
            <div class="input-group">
                <button class="button" onclick="testRealLLM()">ğŸš€ å¼€å§‹çœŸå® LLM æµ‹è¯•</button>
                <button class="button danger" onclick="abortTest()">ğŸ›‘ ä¸­æ–­æµ‹è¯•</button>
                <button class="button" onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
            
            <div class="card">
                <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
                <div id="log" class="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
            
            <div class="card">
                <h3>ğŸ’¬ LLM å“åº”</h3>
                <div id="response" class="log">ç­‰å¾… LLM å“åº”...</div>
            </div>
        </div>
    </div>

    <script type="module">
        let currentTaskLoop = null;
        let currentUnsubscribe = null;
        
        window.testRealLLM = async function () {
            showStatus('å¼€å§‹çœŸå® LLM æµ‹è¯•...', 'info');
            addLog('=== çœŸå® LLM ç«¯åˆ°ç«¯æµ‹è¯•å¼€å§‹ ===');
            
            try {
                // è·å–æµ‹è¯•å‚æ•°
                const apiKeyInput = document.getElementById('apiKey').value.trim();
                const testMessage = document.getElementById('testMessage').value.trim();
                
                if (!testMessage) {
                    throw new Error('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯');
                }
                
                // åŠ¨æ€å¯¼å…¥æ¨¡å—
                addLog('ğŸ“¦ å¯¼å…¥å¿…è¦æ¨¡å—...');
                const { TaskLoop } = await import('./src/store/index.js').catch(() => 
                    import('/src/engine/stream/task-loop.js').catch(() => {
                        throw new Error('æ— æ³•å¯¼å…¥ TaskLoop æ¨¡å—ï¼Œè¯·ç¡®ä¿åœ¨æ­£ç¡®çš„åº”ç”¨ç¯å¢ƒä¸­è¿è¡Œ');
                    })
                );
                
                const { llms } = await import('/src/engine/utils/llms.js').catch(() => {
                    throw new Error('æ— æ³•å¯¼å…¥ llms é…ç½®');
                });
                
                addLog('âœ… æ¨¡å—å¯¼å…¥æˆåŠŸ');
                
                // è·å– LLM é…ç½®
                let apiKey = apiKeyInput;
                let llmConfig = llms[0]; // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ª (deepseek)
                
                if (!apiKey) {
                    // å°è¯•ä»åº”ç”¨é…ç½®è·å–
                    const store = window.__REDUX_STORE__;
                    if (store) {
                        const state = store.getState();
                        apiKey = state.llmConfig?.apiKeys?.deepseek || '';
                        addLog(`âœ… ä»åº”ç”¨é…ç½®è·å– API Key: ${apiKey ? 'å·²é…ç½®' : 'æœªé…ç½®'}`);
                    }
                }
                
                if (!apiKey) {
                    throw new Error('API Key æœªé…ç½®ï¼Œè¯·åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æˆ–åœ¨åº”ç”¨è®¾ç½®ä¸­é…ç½®');
                }
                
                addLog(`ğŸ”§ ä½¿ç”¨ LLM é…ç½®: ${llmConfig.name} (${llmConfig.models[0]})`);
                
                // åˆ›å»º TaskLoop
                addLog('ğŸš€ åˆ›å»º TaskLoop å®ä¾‹...');
                currentTaskLoop = new TaskLoop({
                    chatId: 'e2e-test-' + Date.now(),
                    history: [],
                    config: {
                        baseURL: llmConfig.baseUrl,
                        apiKey: apiKey,
                        model: llmConfig.models[0],
                        temperature: 0.7,
                        maxTokens: 200
                    },
                    mcpClient: null
                });
                
                addLog('âœ… TaskLoop å®ä¾‹åˆ›å»ºæˆåŠŸ');
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬
                let eventCount = 0;
                let responseContent = '';
                let startTime = Date.now();
                
                currentUnsubscribe = currentTaskLoop.subscribe((event) => {
                    eventCount++;
                    const timestamp = Date.now() - startTime;
                    addLog(`[${timestamp}ms] ğŸ“¦ äº‹ä»¶ ${eventCount}: ${event.type}`);
                    
                    switch (event.type) {
                        case 'add':
                            if (event.message?.role === 'user') {
                                addLog(`  â””â”€ ç”¨æˆ·æ¶ˆæ¯: ${event.message.content?.substring(0, 50)}...`);
                            }
                            if (event.message?.role === 'assistant') {
                                addLog(`  â””â”€ åŠ©æ‰‹æ¶ˆæ¯å¼€å§‹`);
                                responseContent = event.message.content || '';
                                updateResponse(responseContent);
                            }
                            break;
                            
                        case 'update':
                            if (event.message?.content) {
                                responseContent = event.message.content;
                                updateResponse(responseContent);
                                addLog(`  â””â”€ æµå¼æ›´æ–°: é•¿åº¦ ${responseContent.length}`);
                            }
                            break;
                            
                        case 'status':
                            addLog(`  â””â”€ çŠ¶æ€: ${event.status || JSON.stringify(event)}`);
                            break;
                            
                        case 'done':
                            const duration = Date.now() - startTime;
                            addLog(`  â””â”€ å®Œæˆï¼ç”¨æ—¶: ${duration}ms`);
                            showStatus(`âœ… æµ‹è¯•æˆåŠŸå®Œæˆï¼å“åº”é•¿åº¦: ${responseContent.length} å­—ç¬¦ï¼Œç”¨æ—¶: ${duration}ms`, 'success');
                            cleanup();
                            break;
                            
                        case 'error':
                            addLog(`  â””â”€ é”™è¯¯: ${event.error || JSON.stringify(event)}`);
                            showStatus(`âŒ æµ‹è¯•å¤±è´¥: ${event.error}`, 'error');
                            cleanup();
                            break;
                    }
                });
                
                // å¼€å§‹æµ‹è¯•
                addLog(`ğŸš€ å‘é€æµ‹è¯•æ¶ˆæ¯: "${testMessage}"`);
                showStatus('æ­£åœ¨å‘é€æ¶ˆæ¯åˆ° LLM...', 'info');
                
                await currentTaskLoop.start(testMessage);
                
            } catch (error) {
                addLog(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`);
                showStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                cleanup();
            }
        };
        
        window.abortTest = function () {
            if (currentTaskLoop) {
                addLog('ğŸ›‘ ä¸­æ–­æµ‹è¯•...');
                currentTaskLoop.abortTask();
                showStatus('æµ‹è¯•å·²ä¸­æ–­', 'info');
                cleanup();
            }
        };
        
        window.clearLog = function () {
            document.getElementById('log').innerHTML = '';
            document.getElementById('response').innerHTML = 'ç­‰å¾… LLM å“åº”...';
            hideStatus();
        };
        
        function cleanup() {
            if (currentUnsubscribe) {
                currentUnsubscribe();
                currentUnsubscribe = null;
            }
            currentTaskLoop = null;
        }
        
        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateResponse(content) {
            document.getElementById('response').innerHTML = content || '(ç©ºå“åº”)';
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        addLog('ğŸ“„ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡å°±ç»ª');
        addLog('ğŸ’¡ æç¤º: è¯·ç¡®ä¿åœ¨æ­£ç¡®çš„åº”ç”¨ç¯å¢ƒä¸­è¿è¡Œæ­¤æµ‹è¯•');
    </script>
</body>
</html>